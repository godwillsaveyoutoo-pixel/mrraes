<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mr Raes â€” Spellenoverzicht</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f9fc; --card:#fff; --ink:#0b132b; --muted:#6b7280; --ring:#e6ecf8; --ring2:#dfe6f6;
      --shadow:0 10px 28px rgba(15,23,42,.06); --good:#10b981; --bad:#ef4444; --accent:#2563eb;
      --tile-h: 320px; --tile-r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Arial,sans-serif; color:var(--ink);
      background: radial-gradient(1200px 600px at 80% -10%, #eef3ff 0%, #f7f9fc 50%, #fbfdff 100%);
    }
    .wrap{width:min(1200px,96vw); margin:0 auto; padding:14px}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.95); backdrop-filter:saturate(140%) blur(6px);
      border-bottom:1px solid var(--ring2); box-shadow:var(--shadow);
      padding:10px 14px; display:flex; flex-wrap:wrap; gap:.6rem; align-items:center;
    }
    .spacer{flex:1}
    .chip{display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--ring2); background:#fff;
      border-radius:999px; padding:.35rem .7rem; font-weight:800; box-shadow:var(--shadow)}
    .chip input{border:none; outline:none; font:inherit}
    .ghostbtn{border:1px solid var(--ring2); background:#fff; border-radius:12px; padding:.55rem .8rem; font-weight:800; cursor:pointer}
    .ghostbtn:active{transform:translateY(1px)}
    .pill{display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--ring2); border-radius:999px; padding:.35rem .7rem; background:#fff; font-weight:800}
    .pill.good{ color:var(--good); background:#eafaf4; border-color:#c4eedc }
    .pill.bad{  color:var(--bad);  background:#fdeeee; border-color:#ffd7d7 }

    /* Section heading */
    h2.sec{margin:16px 0 10px; font-size:1.1rem; color:#111827}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
    @media (max-width:1020px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:680px){ .grid{grid-template-columns:1fr} }

    /* Tile */
    .tile{
      background:#fff; border:1px solid var(--ring); border-radius:18px; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column;
      min-height:var(--tile-h);
    }
    .preview{
      position:relative; height:200px; border-bottom:1px solid var(--ring2); background:#fff; overflow:hidden;
    }
    .preview iframe{
      /* schaal de hele game in het mini-kadertje */
      --scale:.35;
      width: calc(100% / var(--scale));
      height: calc(100% / var(--scale));
      transform: scale(var(--scale));
      transform-origin: 0 0;
      border:0; pointer-events:none;    /* tiles blijven click-through naar de knoppen */
    }
    .tile-body{padding:10px 12px; display:flex; flex-direction:column; gap:8px}
    .ttl{font-weight:900; line-height:1.15}
    .meta{display:flex; flex-wrap:wrap; gap:6px}
    .tag{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--ring2); border-radius:999px; padding:.2rem .5rem; background:#fff; font-weight:800; color:#374151}
    .goals{display:flex; gap:6px; flex-wrap:wrap}
    .tile-actions{margin-top:auto; display:flex; gap:8px}
    .btn{border:1px solid var(--ring2); background:#fff; padding:.5rem .7rem; border-radius:10px; font:800 .95rem Inter; cursor:pointer}
    .btn.primary{background:#2563eb; color:#fff; border-color:#215bd9}
    .muted{color:#6b7280; font-weight:700}

    .empty{padding:18px; border:1px dashed var(--ring2); border-radius:12px; text-align:center; color:#6b7280}

    /* Lazy loading */
    .preview[data-state="idle"]{background:linear-gradient(90deg,#f6f8fc 0%,#eef2ff 50%,#f6f8fc 100%); background-size:200% 100%; animation:sh 1.2s infinite}
    @keyframes sh{0%{background-position:0 0}100%{background-position:200% 0}}
  </style>
</head>
<body>
  <div class="topbar">
    <strong style="font-size:1.05rem">ðŸŽ® Mr Raes â€” Spellen</strong>
    <span class="chip">ðŸ”Ž <input id="q" placeholder="Zoeken op titel, doel, graadâ€¦" size="26" /></span>
    <button id="forceRefresh" class="ghostbtn" title="Cache wissen + opnieuw laden">âŸ³ Vernieuwen</button>
    <div class="spacer"></div>
    <span class="pill good" id="countChip">0 spellen</span>
    <span class="pill" id="modeChip">Bron: <strong id="sourceMode">games.json</strong></span>
  </div>

  <div class="wrap" id="content">
    <div class="empty">Even ladenâ€¦</div>
  </div>

  <script>
  // ====== Instellingen (pas aan indien nodig) ======
  const ORDER = [
    "Lengte en Oppervlakte",
    "Afronden en schatten",
    "Rekenen",
    "Procenten",
    "Getallen",
    "Breuken",
    "Allerlei",
    "Context",
    "Overig"
  ];
  // Als OWNER/REPO niet uit de URL te halen zijn, zet ze hier:
  let OWNER = null;   // bv. "mrraes"
  let REPO  = null;   // bv. "mrraes-math"
  let BRANCH = "main"; // of "gh-pages" als je die gebruikt

  // ====== Helpers ======
  const $ = sel => document.querySelector(sel);
  const el = (tag, props={}, ...kids) => {
    const n = document.createElement(tag);
    Object.assign(n, props);
    for (const k of kids) n.append(k);
    return n;
  };
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  function repoFromLocation(){
    try{
      const host = location.hostname;         // bv. mrraes.github.io
      const parts = location.pathname.replace(/^\/+/,'').split('/'); // ["repoName", ...]
      if (!OWNER && host.endsWith('.github.io')) OWNER = host.replace(/\.github\.io$/,'');
      if (!REPO) REPO = parts[0] || OWNER;
    }catch(e){}
  }
  repoFromLocation();

  function deriveCategory(filename, titleText){
    // Pak prefix vÃ³Ã³r " - " als categorie; fallback op 1e woord van titel
    const base = filename.replace(/\.html?$/,'');
    const byDash = base.split(' - ')[0];
    if (byDash && /[A-Za-zÃ€-Ã¿]/.test(byDash)) return byDash.trim();
    if (titleText && titleText.includes('â€”')){
      return titleText.split('â€”')[0].trim();
    }
    return "Overig";
  }
  function deriveStreamFromName(nameOrTitle){
    const m = String(nameOrTitle||'').match(/\(([^)]+)\)\s*$/);
    return m ? m[1] : "";
  }

  function parseGoalsFromHtml(html){
    // Zoekt bv. const GOALS = ['BV1_06.02','06.02.01', ...];
    const m = html.match(/GOALS?\s*=\s*\[([^\]]*)\]/i);
    if (!m) return [];
    const inside = m[1];
    // Extracteer strings of losse codes
    const arr = Array.from(inside.matchAll(/['"]([^'"]+)['"]/g)).map(x=>x[1].trim());
    // Fallback: cijfers/letters zonder quotes
    if (!arr.length){
      return inside.split(/[,\s]+/).map(s=>s.replace(/['"]/g,'').trim()).filter(Boolean);
    }
    return arr;
  }
  function parseMeta(html, filename){
    const title = (html.match(/<title>([^<]+)<\/title>/i)?.[1]||'').trim();
    const metaId = (html.match(/<meta\s+name=["']x-game-id["']\s+content=["']([^"']+)/i)?.[1]||'').trim();
    const goals = parseGoalsFromHtml(html);
    const stream = deriveStreamFromName(metaId || title || filename);
    const cat = deriveCategory(filename, title||metaId);
    const niceTitle = metaId || title || filename.replace(/\.html?$/,'');
    return { title: niceTitle, goals, stream, category: cat };
  }

  // ---- Data laden: eerst games.json, dan GitHub API fallback ----
  async function tryGamesJson(){
    try{
      const r = await fetch('games.json', {cache:'no-store'});
      if (!r.ok) throw new Error('no games.json');
      const data = await r.json();
      $('#sourceMode').textContent = 'games.json';
      return data;
    }catch(e){ return null; }
  }

  async function listViaGitHubAPI(){
    if (!OWNER || !REPO) throw new Error('OWNER/REPO onbekend; zet ze bovenaan in het script.');
    // Probeer main Ã©n gh-pages als fallback
    for (const br of [BRANCH, BRANCH==='main'?'gh-pages':'main']){
      try{
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/?ref=${encodeURIComponent(br)}`;
        const r = await fetch(url, {headers:{'Accept':'application/vnd.github.v3+json'}});
        if (!r.ok) continue;
        const items = await r.json();
        const files = items.filter(it => it.type==='file' && /\.html?$/.test(it.name) && !/^index\.html?$/i.test(it.name) && !/mrraes-shared/i.test(it.name));
        $('#sourceMode').textContent = 'GitHub API';
        return files.map(f => ({ file: f.name }));
      }catch(e){}
    }
    throw new Error('Kon repo-inhoud niet ophalen via GitHub API.');
  }

  async function enrichFiles(entries){
    // Voor elke file: fetch de HTML en haal metadata
    const out = [];
    for (const ent of entries){
      const name = ent.file;
      try{
        const resp = await fetch(name, {cache:'no-store'});
        const html = await resp.text();
        const meta = parseMeta(html, name);
        out.push({ file:name, ...meta });
        // Kleine pauze om burst te temperen
        await sleep(40);
      }catch(e){
        out.push({ file:name, title:name.replace(/\.html?$/,''), category:deriveCategory(name), goals:[], stream:'' });
      }
    }
    return out;
  }

  function groupByCategory(items){
    const map = new Map();
    for (const it of items){
      const k = it.category || 'Overig';
      if (!map.has(k)) map.set(k, []);
      map.get(k).push(it);
    }
    // sorteer binnen categorie op titel
    for (const arr of map.values()){ arr.sort((a,b)=>a.title.localeCompare(b.title,'nl')) }
    return map;
  }

  function render(all){
    const q = ($('#q').value||'').toLowerCase().trim();
    const filtered = q ? all.filter(it => (
      it.title.toLowerCase().includes(q) ||
      it.file.toLowerCase().includes(q) ||
      (it.stream||'').toLowerCase().includes(q) ||
      (it.goals||[]).join(' ').toLowerCase().includes(q))) : all;

    $('#countChip').innerHTML = `${filtered.length} spellen`;

    const byCat = groupByCategory(filtered);
    const container = $('#content');
    container.innerHTML = '';

    // Sorteer categorie-volgorde zoals ORDER
    const cats = Array.from(byCat.keys()).sort((a,b)=>{
      const ia = Math.max(ORDER.indexOf(a), 999), ib = Math.max(ORDER.indexOf(b), 999);
      return ia===ib ? a.localeCompare(b,'nl') : ia-ib;
    });

    for (const cat of cats){
      container.append(el('h2',{className:'sec'}, document.createTextNode(cat)));
      const grid = el('div',{className:'grid'});
      container.append(grid);

      for (const it of byCat.get(cat)){
        const tile = el('div',{className:'tile'});

        // preview (lazy iframe)
        const prev = el('div',{className:'preview','data-state':'idle'});
        const iframe = el('iframe',{loading:'lazy',sandbox:'allow-same-origin', title:`Preview ${it.title}`});
        // Lazy: enkel src zetten als in viewport
        prev.append(iframe);
        tile.append(prev);

        const body = el('div',{className:'tile-body'});
        body.append(el('div',{className:'ttl'}, document.createTextNode(it.title)));
        const meta = el('div',{className:'meta'});
        if (it.stream) meta.append(el('span',{className:'tag'}, `ðŸŽ“ ${it.stream}`));
        meta.append(el('span',{className:'tag muted'}, `ðŸ“„ ${it.file}`));
        body.append(meta);

        if (it.goals?.length){
          const goals = el('div',{className:'goals'});
          it.goals.slice(0,6).forEach(g => goals.append(el('span',{className:'tag'}, g)));
          if (it.goals.length>6) goals.append(el('span',{className:'tag muted'}, `+${it.goals.length-6}`));
          body.append(goals);
        }

        const actions = el('div',{className:'tile-actions'});
        const openBtn = el('button',{className:'btn primary', onclick:()=>window.open(it.file,'_blank')}, 'Open spel');
        const miniBtn = el('button',{className:'btn', onclick:()=>{ iframe.style.setProperty('--scale', iframe.style.getPropertyValue('--scale')==='.35' ? '.28' : '.35'); }}, 'Zoom mini');
        actions.append(openBtn, miniBtn);
        body.append(actions);

        tile.append(body);
        grid.append(tile);

        // IntersectionObserver voor echte lazy load
        observe(prev, ()=>{ iframe.src = it.file; prev.dataset.state='ready'; });
      }
    }
  }

  // Simple IO for lazy iframes
  const IO = new IntersectionObserver((entries)=>{
    for (const e of entries){
      if (e.isIntersecting){
        const cb = e.target.__onEnter;
        if (cb){ cb(); e.target.__onEnter = null; IO.unobserve(e.target); }
      }
    }
  }, {rootMargin:'200px'});
  function observe(elm, onEnter){ elm.__onEnter = onEnter; IO.observe(elm); }

  // ====== Start ======
  (async function init(){
    $('#q').addEventListener('input', ()=>render(window.__GAMES||[]));
    $('#forceRefresh').addEventListener('click', ()=>{
      localStorage.removeItem('mr_index_cache');
      location.reload();
    });

    // Cache (5 min)
    const cached = localStorage.getItem('mr_index_cache');
    if (cached){
      try{
        const {ts, data} = JSON.parse(cached);
        if (Date.now()-ts < 5*60*1000){
          window.__GAMES = data;
          render(data);
        }
      }catch{}
    }

    // 1) Probeer games.json
    let entries = await tryGamesJson();
    if (!entries){
      // 2) Anders: GitHub API â†’ lijst
      const list = await listViaGitHubAPI();
      // 3) Verrijk met metadata door file te lezen
      entries = await enrichFiles(list);
    }

    window.__GAMES = entries;
    localStorage.setItem('mr_index_cache', JSON.stringify({ts:Date.now(), data:entries}));
    render(entries);
  })();
  </script>
</body>
</html>
